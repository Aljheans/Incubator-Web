<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>IoT Incubator Monitor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      background-color: #f7f9fc;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .app-container {
      width: 100%;
      max-width: 420px;
      background: white;
      border-radius: 14px;
      box-shadow: 0 4px 14px rgba(0,0,0,0.15);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    header {
      background: linear-gradient(90deg, #64b5f6, #2196f3);
      color: #fff;
      text-align: center;
      padding: 18px;
      font-weight: 600;
      font-size: 20px;
    }
    #loading-screen {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: linear-gradient(135deg, #bbdefb, #90caf9);
      color: #0d47a1;
    }
    .spinner {
      height: 90px;
      width: 90px;
      border-radius: 50%;
      background: linear-gradient(45deg, #64b5f6, #1976d2);
      display: flex;
      align-items: center;
      justify-content: center;
      animation: spin 1.8s linear infinite;
      font-size: 40px;
      color: #fff;
    }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    #dashboard { display: none; flex: 1; flex-direction: column; }

    #camera-buttons {
      padding: 10px;
      display: flex;
      gap: 10px;
      overflow-x: auto;
      background-color: #e3f2fd;
    }
    #camera-buttons button {
      flex-shrink: 0;
      padding: 6px 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      background: #bbdefb;
    }

    #image-section {
      width: 100%;
      height: 200px;
      background-color: #e3f2fd;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      margin-top: 10px;
      overflow: hidden;
    }
    #camera-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }
    #no-image { color: #555; }

    #sensor-cards {
      padding: 16px;
      flex: 1;
      overflow-y: auto;
    }
    .sensor-card {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #ffffff;
      margin-bottom: 14px;
      padding: 16px;
      border-radius: 16px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.05);
    }
    .sensor-info { display: flex; align-items: center; gap: 12px; }
    .sensor-icon { font-size: 26px; }
    .sensor-title { font-weight: 600; font-size: 15px; }
    .sensor-value { font-size: 20px; font-weight: bold; }
    .status-tag { padding: 6px 10px; border-radius: 8px; font-weight: 600; font-size: 13px; }
    .last-updated { text-align: center; font-size: 13px; color: #777; margin-top: 10px; }
    footer { text-align: center; font-size: 12px; color: #aaa; padding: 8px; }
  </style>
</head>
<body>
<div class="app-container">

  <div id="loading-screen">
    <div class="spinner">üì°</div>
    <h2>Connecting to Backend...</h2>
  </div>

  <div id="dashboard">
    <header>IoT Incubator Monitor</header>

    <div id="camera-buttons">
      <button id="btn-cam1">Top Right</button>
      <button id="btn-cam2">Bottom Right</button>
      <button id="btn-cam3">Top Left</button>
      <button id="btn-cam4">Bottom Left</button>
    </div>

    <div id="image-section">
      <p id="no-image">No Image Available</p>
      <img id="camera-image">
    </div>

    <div id="sensor-cards">
      <div id="temp-card" class="sensor-card"></div>
      <div id="hum-card" class="sensor-card"></div>
      <div id="water-card" class="sensor-card"></div>
      <div id="days-card" class="sensor-card"></div>
      <div class="last-updated" id="last-updated">Last updated: --:--:--</div>
    </div>

    <footer>&copy; 2025 IoT Incubator Monitor</footer>
  </div>
</div>

<script>
  const backendWebsocket = "wss://incubator-whue.onrender.com/ws";
  let socket;
  let devices = {};
  let selectedCam = "1";

  const loadingScreen = document.getElementById("loading-screen");
  const dashboard = document.getElementById("dashboard");
  const cameraImage = document.getElementById("camera-image");
  const noImage = document.getElementById("no-image");

  const buttons = {
    "1": document.getElementById("btn-cam1"),
    "cam2": document.getElementById("btn-cam2"),
    "cam3": document.getElementById("btn-cam3"),
    "cam4": document.getElementById("btn-cam4")
  };

  Object.keys(buttons).forEach(cam => {
    buttons[cam].onclick = () => {
      selectedCam = cam;
      highlightButton();
      updateCameraImage();
    };
  });

  function highlightButton() {
    Object.keys(buttons).forEach(c => {
      buttons[c].style.background = c === selectedCam ? "#2196f3" : "#bbdefb";
      buttons[c].style.color = c === selectedCam ? "#fff" : "#000";
    });
  }

  function connect() {
    socket = new WebSocket(backendWebsocket);

    socket.onopen = () => {
      loadingScreen.style.display = "none";
      dashboard.style.display = "flex";
      highlightButton();
      setInterval(() => socket.send("ping"), 20000);
    };

    socket.onmessage = (event) => {
      if (event.data === "ping" || event.data === "pong") return;
      try {
        const data = JSON.parse(event.data);
        devices[data.cam_id] = data;
        updateDashboard();
      } catch {}
    };

    socket.onclose = reconnect;
    socket.onerror = reconnect;
  }

  function reconnect() {
    dashboard.style.display = "none";
    loadingScreen.style.display = "flex";
    setTimeout(connect, 3000);
  }

  function updateDashboard() {
    const d = devices["1"] || {};
    document.getElementById("temp-card").innerHTML = makeCard("üå°Ô∏è", "Temperature", `${(d.temperature||0).toFixed(1)}¬∞C`);
    document.getElementById("hum-card").innerHTML = makeCard("üíß", "Humidity", `${(d.humidity||0).toFixed(1)}%`);
    document.getElementById("water-card").innerHTML = makeCard("üö∞", "Water Level", d.water_level==0?"Present":"Refill");
    document.getElementById("days-card").innerHTML = makeCard("üìÖ", "Days", `${d.days||0}`);
    document.getElementById("last-updated").textContent = "Last updated: " + new Date().toLocaleTimeString();
    updateCameraImage();
  }

  function updateCameraImage() {
    const cam = devices[selectedCam];
    if (cam && cam.image) {
      cameraImage.src = "data:image/jpeg;base64," + cam.image;
      cameraImage.style.display = "block";
      noImage.style.display = "none";
    } else {
      cameraImage.style.display = "none";
      noImage.style.display = "block";
    }
  }

  function makeCard(icon, title, value) {
    return `
      <div class="sensor-info">
        <span class="sensor-icon">${icon}</span>
        <div>
          <div class="sensor-title">${title}</div>
          <div class="sensor-value">${value}</div>
        </div>
      </div>`;
  }

  connect();
</script>
</body>
</html>
