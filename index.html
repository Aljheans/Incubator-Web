<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>IoT Incubator Monitor</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: 'Poppins', sans-serif;
  background: #f7f7fc;
}

#loading {
  height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  background: linear-gradient(135deg, #bbdefb, #90caf9);
}

.spinner {
  width: 90px;
  height: 90px;
  border-radius: 50%;
  background: linear-gradient(45deg, #64b5f6, #1976d2);
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 40px;
  animation: spin 2s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to   { transform: rotate(360deg); }
}

#dashboard {
  display: none;
  height: 100vh;
  flex-direction: column;
}

header {
  background: #2196f3;
  color: white;
  padding: 16px;
  text-align: center;
  font-size: 20px;
  font-weight: 600;
}

#camera-bar {
  padding: 10px;
  overflow-x: auto;
  background: #e3f2fd;
  display: flex;
  gap: 10px;
}

.cam-btn {
  padding: 8px 14px;
  border-radius: 8px;
  border: none;
  font-weight: 600;
  cursor: pointer;
  background: #9e9e9e;
  color: white;
  white-space: nowrap;
}

.cam-btn.active {
  background: #2196f3;
}

#image-box {
  padding: 16px;
}

#image-container {
  width: 100%;
  height: 200px;
  border-radius: 8px;
  background: #e3f2fd;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

#camera-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: none;
}

#sensors {
  padding: 16px;
  flex: 1;
  overflow-y: auto;
}

.card {
  background: white;
  border-radius: 16px;
  padding: 16px;
  margin-bottom: 14px;
  display: flex;
  justify-content: space-between;
  box-shadow: 0 3px 10px rgba(0,0,0,0.05);
}

.left {
  display: flex;
  gap: 12px;
}

.icon {
  font-size: 26px;
}

.title {
  font-size: 15px;
  font-weight: 600;
}

.value {
  font-size: 20px;
  font-weight: bold;
}

.tag {
  padding: 6px 10px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: bold;
}

#updated {
  text-align: center;
  font-size: 13px;
  color: #555;
  margin-top: 10px;
}
</style>
</head>

<body>

<div id="loading">
  <div class="spinner">ðŸ“¡</div>
  <h3>Connecting to Backend...</h3>
</div>

<div id="dashboard">
  <header>IoT Incubator Monitor</header>

  <div id="camera-bar">
    <button class="cam-btn active" data-cam="1">Top Right</button>
    <button class="cam-btn" data-cam="cam2">Bottom Right</button>
    <button class="cam-btn" data-cam="cam3">Top Left</button>
    <button class="cam-btn" data-cam="cam4">Bottom Left</button>
  </div>

  <div id="image-box">
    <div id="image-container">
      <span id="no-image">No Image Available</span>
      <img id="camera-image">
    </div>
  </div>

  <div id="sensors"></div>
</div>

<script>
const WS_URL = "wss://incubator-whue.onrender.com/ws";

let socket;
let devices = {};
let selectedCam = "1";

const loading = document.getElementById("loading");
const dashboard = document.getElementById("dashboard");
const camButtons = document.querySelectorAll(".cam-btn");
const img = document.getElementById("camera-image");
const noImg = document.getElementById("no-image");
const sensorsDiv = document.getElementById("sensors");

camButtons.forEach(btn => {
  btn.onclick = () => {
    camButtons.forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    selectedCam = btn.dataset.cam;
    updateImage();
  };
});

function connect() {
  socket = new WebSocket(WS_URL);

  socket.onopen = () => {
    loading.style.display = "none";
    dashboard.style.display = "flex";
    setInterval(() => socket.send("ping"), 20000);
  };

  socket.onmessage = e => {
    if (e.data === "ping" || e.data === "pong") return;
    try {
      const data = JSON.parse(e.data);
      if (data.type === "sensor_data" && data.cam_id) {
        devices[data.cam_id] = data;
        updateDashboard();
      }
    } catch {}
  };

  socket.onclose = reconnect;
  socket.onerror = reconnect;
}

function reconnect() {
  dashboard.style.display = "none";
  loading.style.display = "flex";
  setTimeout(connect, 3000);
}

function updateImage() {
  const cam = devices[selectedCam];
  if (cam && cam.image) {
    img.src = "data:image/jpeg;base64," + cam.image;
    img.style.display = "block";
    noImg.style.display = "none";
  } else {
    img.style.display = "none";
    noImg.style.display = "block";
  }
}

function updateDashboard() {
  const d = devices["1"] || {};
  const t = +d.temperature || 0;
  const h = +d.humidity || 0;
  const w = +d.water_level || 0;
  const days = +d.days || 0;

  sensorsDiv.innerHTML = `
    ${card("ðŸŒ¡ï¸","Temperature",`${t.toFixed(1)}Â°C`,
      t>38?"High":t<37.5?"Low":"Normal",
      t>38?"#e53935":t<37.5?"#fb8c00":"#43a047")}
    ${card("ðŸ’§","Humidity",`${h.toFixed(1)}%`,
      h>70?"High":h<40?"Low":"OK",
      h>70?"#e53935":h<40?"#fb8c00":"#1e88e5")}
    ${card("ðŸš°","Water Level",w===0?"Present":"Refill",
      w===0?"OK":"Empty",
      w===0?"#1e88e5":"#e53935")}
    ${card("ðŸ“…","Days Incubating",`${days} days`,
      days>0?"Running":"Idle",
      days>0?"#8e24aa":"#757575")}
    <div id="updated">Last updated: ${new Date().toLocaleTimeString()}</div>
  `;

  updateImage();
}

function card(icon,title,value,status,color){
  return `
  <div class="card">
    <div class="left">
      <div class="icon" style="color:${color}">${icon}</div>
      <div>
        <div class="title">${title}</div>
        <div class="value" style="color:${color}">${value}</div>
      </div>
    </div>
    <div class="tag" style="color:${color};background:${color}22">${status}</div>
  </div>`;
}

connect();
</script>

</body>
</html>
